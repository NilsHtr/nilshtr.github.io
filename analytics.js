function getGoalKey(e,t,a){return`goal_${e}_${t}_${a}`}document.addEventListener("DOMContentLoaded",()=>{let e=localStorage.getItem("selectedSport");if(!e){window.location.href="index.html";return}let t=document.getElementById("goalDate"),a=document.getElementById("goalValue"),l=document.getElementById("setGoal"),n=document.getElementById("clearGoal"),o=null,r=document.getElementById("sportType");r.textContent=e.charAt(0).toUpperCase()+e.slice(1);let i=document.getElementById("datasetSelect"),d=document.getElementById("metricSelect"),u=null,s=document.getElementById("analysisChart"),v=`trainingHistory_${e}`,c=JSON.parse(localStorage.getItem(v)||"[]"),m=new Set;function g(e){if(d.innerHTML='<option value="">Bitte w\xe4hlen...</option>',!e)return;let t=c.find(t=>t.tableData.rows.some(t=>t[0]?.trim()===e));t&&t.tableData.headers.slice(1).forEach((e,t)=>{let a=document.createElement("option");a.value=t+1,a.textContent=e,d.appendChild(a)})}function p(l,n){if(!l||!n)return;let r=[];c.forEach(e=>{let t=e.tableData.rows.find(e=>e[0]?.trim()===l);if(t&&t[n]){let a=parseFloat(t[n]);isNaN(a)||r.push({x:new Date(e.date),y:a})}}),r.sort((e,t)=>e.x-t.x),o=getGoalKey(e,l,n);let i=JSON.parse(localStorage.getItem(o)||"null"),d=[];if(i&&r.length>0){let v=r[0];d=[{x:v.x,y:v.y},{x:new Date(i.date),y:i.value}]}i?(t.value=i.date.split("T")[0],a.value=i.value):(t.value="",a.value=""),u&&u.destroy();let m=s.getContext("2d");u=new Chart(m,{type:"line",data:{datasets:[{label:"Werte",data:r,borderColor:"rgb(75, 192, 192)",tension:.1},{label:"Trend zum Ziel",data:d,borderColor:"gold",borderWidth:2,borderDash:[5,5],pointStyle:!1},{label:"Ziel",data:i?[{x:new Date(i.date),y:i.value}]:[],borderColor:"gold",backgroundColor:"gold",pointStyle:"star",pointRadius:10}]},options:{scales:{x:{type:"time",time:{unit:"day"}}},responsive:!0,maintainAspectRatio:!1}})}c.forEach(e=>{e.tableData.rows.forEach(e=>{e[0]&&e[0].trim()&&m.add(e[0].trim())})}),Array.from(m).sort().forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=e,i.appendChild(t)}),i.addEventListener("change",()=>{g(i.value),p(i.value,parseInt(d.value))}),d.addEventListener("change",()=>{p(i.value,parseInt(d.value))}),l.addEventListener("click",()=>{if(!o||!t.value||!a.value)return;let e={date:t.value,value:parseFloat(a.value)};localStorage.setItem(o,JSON.stringify(e)),p(i.value,d.value)}),n.addEventListener("click",()=>{o&&(localStorage.removeItem(o),t.value="",a.value="",p(i.value,d.value))})});